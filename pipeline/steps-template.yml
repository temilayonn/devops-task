
parameters:
  - name: docker_username
    type: string
  - name: docker_password
    type: string
  - name: frontend_image
    type: string
  - name: backend_image
    type: string
  - name: docker_image_tag
    type: string

steps:
  - task: Bash@3
    inputs:
      targetType: 'inline'
      script: |
        #!/bin/bash

        # Assign parameters to variables
        DOCKER_USERNAME="${{ parameters.docker_username }}"
        DOCKER_PASSWORD="${{ parameters.docker_password }}"
        FRONTEND_IMAGE="${{ parameters.frontend_image }}"
        BACKEND_IMAGE="${{ parameters.backend_image }}"
        DOCKER_IMAGE_TAG="${{ parameters.docker_image_tag }}"
        DOCKER_FRONTEND_REPO="$DOCKER_USERNAME/$FRONTEND_IMAGE"
        DOCKER_BACKEND_REPO="$DOCKER_USERNAME/$BACKEND_IMAGE"

        # Function to handle errors
        handle_error() {
          echo "Error: $1"
          exit 1
        }

        # Login to Docker Hub
        echo "Logging into Docker Hub..."
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin || handle_error "Failed to login to Docker Hub"

        # Build and push images
        echo "Building and pushing Docker images..."
        for image in "$FRONTEND_IMAGE" "$BACKEND_IMAGE"; do
          docker build -t "$DOCKER_USERNAME/$image:$DOCKER_IMAGE_TAG" ./$image || handle_error "Failed to build $image Docker image"
          docker push "$DOCKER_USERNAME/$image:$DOCKER_IMAGE_TAG" || handle_error "Failed to push $image Docker image"
        done

        # Pull images from Docker Hub
        echo "Pulling Docker images..."
        for image in "$FRONTEND_IMAGE" "$BACKEND_IMAGE"; do
          docker pull "$DOCKER_USERNAME/$image:$DOCKER_IMAGE_TAG" || handle_error "Failed to pull $image Docker image"
        done

        # Update docker-compose.yml
        echo "Updating docker-compose.yml..."
        sed -i "s|image:.*frontend.*|image: $DOCKER_FRONTEND_REPO:$DOCKER_IMAGE_TAG|g" docker-compose.yml
        sed -i "s|image:.*backend.*|image: $DOCKER_BACKEND_REPO:$DOCKER_IMAGE_TAG|g" docker-compose.yml || handle_error "Failed to update docker-compose.yml"

        # Start services
        echo "Starting services with Docker Compose..."
        docker-compose up -d || handle_error "Failed to start services with Docker Compose"

        # Display running services
        echo "Listing running containers..."
        docker-compose ps

        echo "Done! The frontend and backend services are built, pushed, pulled, and running on the host."
